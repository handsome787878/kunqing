# 鲲擎校园 - 前后端详细说明文档

## 📋 项目概述

**鲲擎校园**是一个基于Flask框架开发的校园综合服务平台，旨在为高校师生提供便捷的校园生活服务。该项目采用前后端分离的架构设计，提供用户认证、失物招领、二手书交易、课程评价、学习小组等核心功能模块。

### 🎯 项目特点

- **模块化设计**：采用Blueprint蓝图模式，各功能模块独立开发和维护
- **响应式界面**：基于现代CSS设计，支持多设备适配
- **数据持久化**：支持SQLite和MySQL双数据库方案
- **用户友好**：简洁直观的用户界面，良好的用户体验
- **安全可靠**：完善的用户认证和权限管理机制

### 🏗️ 技术栈

#### 后端技术栈
- **Web框架**: Flask 2.3.3
- **数据库ORM**: Flask-SQLAlchemy 3.0.5
- **用户认证**: Flask-Login 0.6.3
- **表单处理**: Flask-WTF 1.1.1, WTForms 3.0.1
- **密码加密**: bcrypt 4.0.1
- **邮箱验证**: email-validator 2.0.0
- **图像处理**: Pillow 10.0.0
- **数据库**: SQLite (开发环境) / MySQL (生产环境)

#### 前端技术栈
- **模板引擎**: Jinja2 (Flask内置)
- **样式框架**: 自定义CSS + 响应式设计
- **JavaScript**: 原生JavaScript
- **图标**: 使用Emoji图标系统

#### 开发工具
- **版本控制**: Git
- **代码托管**: Gitee
- **开发环境**: Python 3.12+
- **IDE**: 支持多种IDE (PyCharm, VSCode等)

## 🏛️ 项目架构

### 📁 目录结构

```
kunqing-campus/
├── app/                          # 应用主目录
│   ├── __init__.py              # 应用工厂函数
│   ├── models.py                # 数据模型定义
│   ├── simple_models.py         # 简化数据模型
│   ├── forms/                   # 表单定义
│   │   ├── __init__.py
│   │   └── auth.py             # 认证相关表单
│   ├── routes/                  # 路由蓝图
│   │   ├── __init__.py
│   │   ├── auth.py             # 用户认证路由
│   │   ├── lost_found.py       # 失物招领路由
│   │   ├── books.py            # 二手书交易路由
│   │   ├── courses.py          # 课程评价路由
│   │   ├── study_groups.py     # 学习小组路由
│   │   └── simple_*.py         # 简化版路由
│   ├── templates/               # 模板文件
│   │   ├── base.html           # 基础模板
│   │   ├── auth/               # 认证模板
│   │   ├── lost_found/         # 失物招领模板
│   │   ├── books/              # 图书交易模板
│   │   ├── courses/            # 课程评价模板
│   │   └── study_groups/       # 学习小组模板
│   ├── static/                  # 静态资源
│   │   ├── css/                # 样式文件
│   │   ├── js/                 # JavaScript文件
│   │   └── images/             # 图片资源
│   └── utils/                   # 工具函数
│       ├── __init__.py
│       ├── decorators.py       # 装饰器
│       └── helpers.py          # 辅助函数
├── mysql/                       # MySQL数据库脚本
│   ├── create_*.sql            # 建表脚本
│   ├── sample_data.sql         # 示例数据
│   └── README.md               # 数据库说明
├── config.py                    # 配置文件
├── requirements.txt             # 依赖包列表
├── run.py                      # 应用启动文件
├── kunqing.sqlite              # SQLite数据库文件
└── README.md                   # 项目说明
```

### 🔧 核心架构设计

#### 1. 应用工厂模式
项目采用Flask应用工厂模式，通过`create_app()`函数创建应用实例，便于测试和部署：

```python
def create_app():
    app = Flask(__name__)
    app.config.from_object(Config)
    
    # 初始化扩展
    login_manager = LoginManager()
    login_manager.init_app(app)
    
    # 注册蓝图
    from .routes import auth_bp, lost_found_bp, books_bp, courses_bp, study_groups_bp
    app.register_blueprint(auth_bp)
    # ... 其他蓝图注册
    
    return app
```

#### 2. 蓝图模块化
使用Flask Blueprint实现功能模块化，每个功能模块独立管理：

- **auth_bp**: 用户认证模块 (`/auth/`)
- **lost_found_bp**: 失物招领模块 (`/lost-found/`)
- **books_bp**: 二手书交易模块 (`/books/`)
- **courses_bp**: 课程评价模块 (`/courses/`)
- **study_groups_bp**: 学习小组模块 (`/study-groups/`)

#### 3. 数据层设计
项目支持两套数据模型：

- **完整模型** (`models.py`): 基于SQLAlchemy ORM的完整数据模型
- **简化模型** (`simple_models.py`): 基于SQLite的轻量级数据模型

## 🎨 前端架构

### 模板系统

#### 基础模板 (base.html)
采用Jinja2模板继承机制，定义了统一的页面结构：

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}鲲擎校园{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar">
        <!-- 导航内容 -->
    </nav>
    
    <!-- 主要内容区域 -->
    <main class="container">
        {% block content %}{% endblock %}
    </main>
    
    <!-- 页脚 -->
    <footer>
        <!-- 页脚内容 -->
    </footer>
</body>
</html>
```

#### 响应式设计
CSS采用现代响应式设计原则：

```css
/* 移动设备适配 */
@media (max-width: 768px) {
    .container {
        padding: 15px;
    }
    
    .nav-menu {
        grid-template-columns: 1fr;
    }
}

/* 小屏幕设备适配 */
@media (max-width: 480px) {
    .main-content {
        padding: 20px;
    }
}
```

### 静态资源管理

#### CSS样式系统
- **style.css**: 主样式文件，包含全局样式和组件样式
- **响应式布局**: 支持桌面、平板、手机多端适配
- **现代设计**: 采用渐变背景、阴影效果、动画过渡

#### JavaScript功能
- **表单验证**: 客户端表单验证
- **交互效果**: 页面交互和动态效果
- **AJAX请求**: 异步数据交互

## ⚙️ 后端架构

### 数据模型设计

#### 用户模型 (User)
```python
class User(db.Model):
    __tablename__ = "users"
    
    id = db.Column(db.Integer, primary_key=True)
    student_id = db.Column(db.String(20), unique=True, nullable=False)
    email = db.Column(db.String(120), unique=True, nullable=False)
    password_hash = db.Column(db.String(128), nullable=False)
    real_name = db.Column(db.String(50))
    college = db.Column(db.String(100))
    major = db.Column(db.String(100))
    grade = db.Column(db.String(20))
    phone = db.Column(db.String(20))
    avatar = db.Column(db.String(255))
    create_time = db.Column(db.DateTime, default=db.func.now())
    last_login = db.Column(db.DateTime)
```

#### 关系映射
用户模型与其他模型建立了完整的关系映射：

- **一对多关系**: 用户 → 失物招领、二手书、课程评价、学习小组
- **多对多关系**: 用户 ↔ 学习小组成员关系

### 路由系统

#### 认证路由 (auth.py)
```python
@auth_bp.route("/login", methods=["GET", "POST"])
def login():
    # 用户登录逻辑
    pass

@auth_bp.route("/register", methods=["GET", "POST"])
def register():
    # 用户注册逻辑
    pass

@auth_bp.route("/logout")
@login_required
def logout():
    # 用户登出逻辑
    pass
```

#### 业务路由
每个功能模块都有对应的路由处理：

- **CRUD操作**: 创建、读取、更新、删除
- **权限控制**: 基于`@login_required`装饰器
- **数据验证**: 表单验证和数据校验
- **错误处理**: 统一的错误处理机制

### 安全机制

#### 用户认证
- **密码加密**: 使用bcrypt进行密码哈希
- **会话管理**: Flask-Login管理用户会话
- **权限控制**: 装饰器实现访问控制

#### 数据安全
- **SQL注入防护**: SQLAlchemy ORM自动防护
- **CSRF保护**: Flask-WTF提供CSRF令牌
- **文件上传安全**: 文件类型和大小限制

## 🔌 功能模块详解

### 1. 用户认证模块

#### 功能特性
- **用户注册**: 学号、邮箱注册，密码强度验证
- **用户登录**: 支持学号或邮箱登录
- **个人资料**: 完善个人信息管理
- **密码重置**: 邮箱验证重置密码

#### API接口
```
POST /auth/register     # 用户注册
POST /auth/login        # 用户登录
GET  /auth/logout       # 用户登出
GET  /auth/profile      # 个人资料页面
POST /auth/profile      # 更新个人资料
```

### 2. 失物招领模块

#### 功能特性
- **物品发布**: 发布丢失或拾到的物品信息
- **分类管理**: 按物品类型分类显示
- **搜索功能**: 关键词搜索物品信息
- **联系方式**: 提供联系方式便于沟通

#### 数据模型
```python
class LostFound(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('users.id'))
    type = db.Column(db.String(20))  # 'lost' or 'found'
    title = db.Column(db.String(200))
    description = db.Column(db.Text)
    location = db.Column(db.String(200))
    contact = db.Column(db.String(100))
    status = db.Column(db.String(20), default='active')
    create_time = db.Column(db.DateTime, default=db.func.now())
```

### 3. 二手书交易模块

#### 功能特性
- **图书发布**: 发布二手书销售信息
- **图书搜索**: 按书名、作者、价格搜索
- **成色描述**: 详细的图书成色说明
- **价格管理**: 灵活的价格设置

#### 业务流程
1. 用户发布二手书信息
2. 其他用户浏览和搜索图书
3. 通过联系方式进行交易沟通
4. 交易完成后更新状态

### 4. 课程评价模块

#### 功能特性
- **课程信息**: 课程名称、代码、教师信息
- **评价系统**: 多维度课程评价
- **评分统计**: 课程平均评分计算
- **评价展示**: 评价内容公开展示

#### 评价维度
- 课程内容质量
- 教师教学水平
- 课程难度评估
- 推荐程度

### 5. 学习小组模块

#### 功能特性
- **小组创建**: 创建学习小组
- **成员管理**: 小组成员加入和退出
- **活动发布**: 发布小组学习活动
- **讨论交流**: 小组内部交流讨论

#### 组织结构
- **小组长**: 小组创建者，拥有管理权限
- **成员**: 普通小组成员
- **活动**: 小组学习活动安排

## 🗄️ 数据库设计

### SQLite方案 (开发环境)
- **轻量级**: 无需额外安装数据库服务
- **便携性**: 数据库文件可随项目移动
- **快速开发**: 适合开发和测试环境

### MySQL方案 (生产环境)
- **高性能**: 支持大并发访问
- **可扩展**: 支持集群和分布式部署
- **完整功能**: 完整的SQL功能支持

### 数据表结构

#### 核心表设计
1. **users**: 用户基础信息表
2. **lost_found**: 失物招领信息表
3. **secondhand_books**: 二手书信息表
4. **courses**: 课程信息表
5. **course_reviews**: 课程评价表
6. **study_groups**: 学习小组表
7. **group_members**: 小组成员关系表

#### 索引优化
- 主键索引: 所有表的id字段
- 唯一索引: 用户学号、邮箱
- 外键索引: 关联表的外键字段
- 查询索引: 常用查询字段

## 🚀 部署指南

### 开发环境搭建

#### 1. 环境要求
- Python 3.8+
- pip包管理器
- Git版本控制

#### 2. 项目克隆
```bash
git clone https://gitee.com/ospuer/kunqing.git
cd kunqing-campus
```

#### 3. 虚拟环境
```bash
# 创建虚拟环境
python -m venv .venv

# 激活虚拟环境 (Windows)
.venv\Scripts\activate

# 激活虚拟环境 (Linux/Mac)
source .venv/bin/activate
```

#### 4. 依赖安装
```bash
pip install -r requirements.txt
```

#### 5. 数据库初始化
```bash
# SQLite数据库会自动创建
# 如需使用MySQL，请参考mysql/目录下的SQL脚本
```

#### 6. 启动应用
```bash
python run.py
```

访问 `http://127.0.0.1:5000` 即可使用应用。

### 生产环境部署

#### 1. 服务器配置
- **操作系统**: Linux (推荐Ubuntu/CentOS)
- **Web服务器**: Nginx
- **WSGI服务器**: Gunicorn
- **数据库**: MySQL 5.7+

#### 2. 环境变量配置
```bash
export SECRET_KEY="your-production-secret-key"
export DATABASE_URL="mysql://user:password@localhost/kunqing"
export MAIL_SERVER="smtp.example.com"
export MAIL_USERNAME="your-email@example.com"
export MAIL_PASSWORD="your-email-password"
```

#### 3. Gunicorn配置
```bash
gunicorn -w 4 -b 0.0.0.0:8000 run:app
```

#### 4. Nginx配置
```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
    
    location /static {
        alias /path/to/kunqing-campus/app/static;
    }
}
```

## 📖 使用说明

### 管理员操作

#### 1. 用户管理
- 查看用户列表
- 用户状态管理
- 权限分配

#### 2. 内容管理
- 审核发布内容
- 删除违规信息
- 数据统计分析

### 普通用户操作

#### 1. 注册登录
1. 访问注册页面
2. 填写学号、邮箱、密码
3. 验证邮箱（如启用）
4. 完善个人资料

#### 2. 功能使用
1. **失物招领**: 发布丢失或拾到物品信息
2. **二手书交易**: 发布或购买二手书籍
3. **课程评价**: 对已修课程进行评价
4. **学习小组**: 创建或加入学习小组

## 🔧 开发指南

### 代码规范

#### Python代码规范
- 遵循PEP 8编码规范
- 使用类型提示 (Type Hints)
- 编写文档字符串 (Docstrings)
- 单元测试覆盖

#### 前端代码规范
- HTML语义化标签
- CSS模块化组织
- JavaScript ES6+语法
- 响应式设计原则

### 扩展开发

#### 添加新功能模块
1. 创建新的Blueprint
2. 定义数据模型
3. 编写路由处理函数
4. 创建模板文件
5. 添加样式和脚本
6. 注册到应用中

#### 数据库迁移
```python
# 使用Flask-Migrate进行数据库迁移
flask db init
flask db migrate -m "Add new table"
flask db upgrade
```

## 🐛 常见问题

### 1. 数据库连接问题
**问题**: 无法连接到数据库
**解决**: 检查数据库配置和连接字符串

### 2. 静态文件加载问题
**问题**: CSS/JS文件无法加载
**解决**: 检查静态文件路径配置

### 3. 权限访问问题
**问题**: 页面提示需要登录
**解决**: 确保用户已正确登录

### 4. 邮件发送问题
**问题**: 邮件验证码发送失败
**解决**: 检查邮件服务器配置

## 📞 技术支持

### 联系方式
- **项目地址**: https://gitee.com/ospuer/kunqing
- **问题反馈**: 通过Gitee Issues提交
- **开发者**: 龚精奎 (2713878912@qq.com)

### 贡献指南
1. Fork项目到个人仓库
2. 创建功能分支
3. 提交代码更改
4. 发起Pull Request
5. 代码审查和合并

## 📄 许可证

本项目采用MIT许可证，详情请参阅LICENSE文件。

---

**最后更新**: 2024年12月
**文档版本**: v1.0
**项目版本**: v1.0.0