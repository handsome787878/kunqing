# 部署上线指南（Flask 项目）

本指南围绕本项目的 Flask 架构，提供从准备到上线的完整路径，覆盖连接外部数据库服务器、Web 服务器反向代理、容器化与托管平台等方案。请根据实际规模、预算和团队经验选择合适路线。

## 核心流程（通用）

1. 准备阶段
- 代码与测试：本地运行正常，通过必要测试。
- 环境配置：梳理环境变量（数据库、邮箱、密钥、调试开关等），切勿硬编码敏感信息。
- 依赖管理：确保 `requirements.txt` 最新；如接入 MySQL，需新增 `pymysql`。
- 数据库准备：创建生产库并初始化表结构与管理员账号（见下文）。

2. 构建阶段
- 静态资源：如果有前端独立构建，完成打包（例：`npm run build`）。
- 容器化（推荐）：用 Docker 打包应用与依赖，保证环境一致性与便捷部署。

3. 部署阶段
- 部署环境：选择云服务器或托管平台，上传代码/镜像。
- Web 服务器：用 Nginx/Apache 处理静态与反向代理到应用服务（Gunicorn/uWSGI）。
- 启动应用：生产模式运行，避免使用 `python run.py`（该方式默认开启 debug）。
- 域名与 SSL：配置域名解析与 HTTPS（Let’s Encrypt/certbot）。

## 连接数据库服务器（MySQL 示例）

- 推荐使用 MySQL 作为生产数据库。连接字符串示例：
- `SQLALCHEMY_DATABASE_URI="mysql+pymysql://kunqing_user:StrongPass@db_host:3306/kunqing_campus?charset=utf8mb4"`
- 依赖：在 `requirements.txt` 增加 `pymysql`（生产前请安装）。
- 初始化表与管理员：
```
# 在服务器上，激活虚拟环境后执行：
python scripts/init_sqlalchemy_db.py
# 该脚本会创建所有 SQLAlchemy 表，并确保存在超管 admin/admin123（随后可修改）。
```
- 迁移策略：当前项目未使用 Flask-Migrate，生产环境如需要变更表结构，请编写迁移脚本或引入 Flask-Migrate。

## 环境变量与生产配置

- 关闭调试：`DEBUG=False` 或使用生产 WSGI 服务器（Gunicorn/uWSGI）。
- 数据库：`SQLALCHEMY_DATABASE_URI` 指向生产库。
- 邮件 SMTP：`MAIL_SERVER`、`MAIL_PORT`、`MAIL_USE_TLS`/`MAIL_USE_SSL`、`MAIL_USERNAME`、`MAIL_PASSWORD`、`MAIL_DEFAULT_SENDER`。
- 其他：`TIMEAGO_LOCALE`、`TIMEAGO_TZ_OFFSET_MINUTES` 如需。

## 云服务器部署（Ubuntu + Nginx + Gunicorn）

1) 服务器初始化
- `apt update && apt upgrade`
- 新建非 root 用户，配置 UFW 防火墙开放 `22/80/443`。

2) 安装运行环境
- 安装 Python3 与 venv；如需 MySQL，安装 `mysql-server` 并创建数据库与用户。
- 安装 Nginx。

3) 拉取与配置项目
```
# 服务器上
git clone <repo>
cd kunqing-campus
python3 -m venv .venv && source .venv/bin/activate
pip install -r requirements.txt
# 如使用 MySQL 且未包含驱动：pip install pymysql
export SQLALCHEMY_DATABASE_URI="mysql+pymysql://kunqing_user:StrongPass@db_host:3306/kunqing_campus?charset=utf8mb4"
export MAIL_SERVER=smtp.qq.com
export MAIL_PORT=587
export MAIL_USE_TLS=True
export MAIL_USERNAME=your@qq.com
export MAIL_PASSWORD=your_auth_code
export MAIL_DEFAULT_SENDER=your@qq.com
python scripts/init_sqlalchemy_db.py
```

4) 使用 Gunicorn 启动应用（生产）
```
# run.py 暴露了 app（app = create_app()），可直接作为 Gunicorn 入口
# 前台试跑
gunicorn -w 3 -b 0.0.0.0:8000 run:app
```

5) Nginx 反向代理配置
```
# /etc/nginx/sites-available/kunqing
server {
    listen 80;
    server_name your_domain.com www.your_domain.com;

    location /static/ {
        alias /var/www/kunqing/static/;
    }

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```
- 启用与重载：
```
sudo ln -s /etc/nginx/sites-available/kunqing /etc/nginx/sites-enabled/kunqing
sudo nginx -t && sudo systemctl reload nginx
```

6) Systemd 管理 Gunicorn（后台运行与自启动）
```
# /etc/systemd/system/kunqing.service
[Unit]
Description=Kunqing Campus Flask App
After=network.target

[Service]
User=www-data
WorkingDirectory=/var/www/kunqing
Environment="SQLALCHEMY_DATABASE_URI=mysql+pymysql://kunqing_user:StrongPass@db_host:3306/kunqing_campus?charset=utf8mb4"
Environment="MAIL_SERVER=smtp.qq.com"
Environment="MAIL_PORT=587"
Environment="MAIL_USE_TLS=True"
Environment="MAIL_USERNAME=your@qq.com"
Environment="MAIL_PASSWORD=your_auth_code"
Environment="MAIL_DEFAULT_SENDER=your@qq.com"
ExecStart=/var/www/kunqing/.venv/bin/gunicorn -w 3 -b 0.0.0.0:8000 run:app
Restart=always

[Install]
WantedBy=multi-user.target
```
- 启动与开机自启：
```
sudo systemctl daemon-reload
sudo systemctl start kunqing
sudo systemctl enable kunqing
```

7) 配置域名与 SSL（Let’s Encrypt）
```
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d your_domain.com -d www.your_domain.com
# 证书自动续期默认通过 systemd timer 实现，可用 `certbot renew --dry-run` 验证
```

## 容器化部署（Docker + Compose）

1) Dockerfile（生产）
```
# Dockerfile
FROM python:3.12-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt && pip install pymysql
COPY . .
ENV FLASK_ENV=production
ENV DEBUG=False
EXPOSE 8000
CMD ["gunicorn", "-w", "3", "-b", "0.0.0.0:8000", "run:app"]
```

2) docker-compose（含 MySQL 示例）
```
# docker-compose.yml
version: "3.9"
services:
  app:
    build: .
    ports:
      - "80:8000"
    environment:
      SQLALCHEMY_DATABASE_URI: "mysql+pymysql://kunqing_user:StrongPass@db:3306/kunqing_campus?charset=utf8mb4"
      MAIL_SERVER: "smtp.qq.com"
      MAIL_PORT: 587
      MAIL_USE_TLS: "True"
      MAIL_USERNAME: "your@qq.com"
      MAIL_PASSWORD: "your_auth_code"
      MAIL_DEFAULT_SENDER: "your@qq.com"
    depends_on:
      - db
  db:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: "RootStrongPass"
      MYSQL_DATABASE: "kunqing_campus"
      MYSQL_USER: "kunqing_user"
      MYSQL_PASSWORD: "StrongPass"
    command: ["--default-authentication-plugin=mysql_native_password"]
    volumes:
      - db_data:/var/lib/mysql
volumes:
  db_data:
```
- 初始化：容器启动后，进入 `app` 容器执行 `python scripts/init_sqlalchemy_db.py` 创建表与管理员。

## 托管平台（Railway / Render / Heroku）

- 适用于不想自行运维的后端应用。
- 启动命令：`gunicorn run:app`。
- Heroku 示例：
```
# Procfile
web: gunicorn run:app
```
- 环境变量：在平台控制台设置 `SQLALCHEMY_DATABASE_URI`、`MAIL_*` 等。

## 部署清单（Checklist）

- 代码已提交到 Git。
- 生产环境变量设置完毕（数据库、邮件、密钥等）。
- `DEBUG` 已关闭，使用生产 WSGI 服务器（Gunicorn/uWSGI）。
- 静态资源处理完成（如有独立前端）。
- 数据库表结构与管理员初始化完成。
- 依赖列表最新并安装成功（含 `pymysql` 如用 MySQL）。
- 应用在本地或容器内以生产方式测试通过。
- 域名解析正确，SSL 证书安装且强制 HTTPS。
- 配置错误监控与日志（如 Sentry、Logtail、Nginx/Gunicorn 日志）。

## 重要提示

- 生产环境请勿使用 `python run.py` 直接启动（该方式会启用 `debug=True`）。请改用 Gunicorn、uWSGI 或容器化方式。
- 数据库账号与密码请使用强密码并限制访问来源。
- SMTP 授权码（如 QQ 邮箱）属于敏感信息，务必通过环境变量或密钥管理服务注入。