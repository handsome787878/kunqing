<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¨æˆ·è¯¦æƒ… - é²²æ“æ ¡å›­ç®¡ç†åå°</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
        }

        .admin-layout {
            display: flex;
            min-height: 100vh;
        }

        /* ä¾§è¾¹æ æ ·å¼ */
        .sidebar {
            width: 260px;
            background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
            color: white;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
        }

        .sidebar-header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-nav {
            padding: 20px 0;
        }

        .nav-item {
            margin-bottom: 5px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .nav-link:hover,
        .nav-link.active {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            border-left-color: #3498db;
        }

        .nav-link i {
            margin-right: 10px;
            font-size: 16px;
            width: 20px;
        }

        /* ä¸»å†…å®¹åŒºåŸŸ */
        .main-content {
            flex: 1;
            margin-left: 260px;
            background-color: #f5f7fa;
        }

        .topbar {
            background: white;
            padding: 15px 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .topbar-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .back-btn {
            padding: 8px 16px;
            background-color: #6c757d;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }

        .back-btn:hover {
            background-color: #5a6268;
        }

        .topbar-left h1 {
            font-size: 24px;
            color: #2c3e50;
        }

        .topbar-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .logout-btn {
            padding: 8px 16px;
            background-color: #e74c3c;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }

        .logout-btn:hover {
            background-color: #c0392b;
        }

        .content-area {
            padding: 30px;
        }

        /* ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ */
        .user-profile {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 20px;
        }

        .profile-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            color: white;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
        }

        .profile-info h2 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .profile-info p {
            opacity: 0.9;
            font-size: 16px;
        }

        .profile-body {
            padding: 30px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .info-label {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }

        .info-value {
            font-size: 16px;
            color: #2c3e50;
            font-weight: 600;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-active {
            background-color: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background-color: #f8d7da;
            color: #721c24;
        }

        .status-admin {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        /* æ“ä½œæŒ‰é’® */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-warning {
            background-color: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background-color: #e67e22;
        }

        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        /* æ´»åŠ¨è®°å½• */
        .activity-section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .section-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }

        .activity-list {
            padding: 20px;
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .activity-login {
            background-color: #e3f2fd;
            color: #1976d2;
        }

        .activity-post {
            background-color: #fff3e0;
            color: #f57c00;
        }

        .activity-comment {
            background-color: #f3e5f5;
            color: #7b1fa2;
        }

        .activity-content {
            flex: 1;
        }

        .activity-title {
            font-weight: 500;
            margin-bottom: 3px;
        }

        .activity-desc {
            font-size: 14px;
            color: #666;
        }

        .activity-time {
            font-size: 12px;
            color: #999;
        }

        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
        }

        /* ç¼–è¾‘è¡¨å• */
        .edit-form {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            padding: 25px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2c3e50;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .form-select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            background-color: white;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .main-content {
                margin-left: 0;
            }

            .profile-header {
                flex-direction: column;
                text-align: center;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="admin-layout">
        <!-- ä¾§è¾¹æ  -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h2>ğŸ›¡ï¸ ç®¡ç†åå°</h2>
                <p>é²²æ“æ ¡å›­</p>
            </div>
            <div class="sidebar-nav">
                <div class="nav-item">
                    <a href="{{ url_for('admin.dashboard') }}" class="nav-link">
                        <i>ğŸ“Š</i> ä»ªè¡¨ç›˜
                    </a>
                </div>
                <div class="nav-item">
                    <a href="{{ url_for('admin.users') }}" class="nav-link active">
                        <i>ğŸ‘¥</i> ç”¨æˆ·ç®¡ç†
                    </a>
                </div>
                <div class="nav-item">
                    <a href="{{ url_for('admin.content') }}" class="nav-link">
                        <i>ğŸ“</i> å†…å®¹ç®¡ç†
                    </a>
                </div>
                <div class="nav-item">
                    <a href="{{ url_for('admin.statistics') }}" class="nav-link">
                        <i>ğŸ“ˆ</i> æ•°æ®ç»Ÿè®¡
                    </a>
                </div>
                <div class="nav-item">
                    <a href="{{ url_for('admin.settings') }}" class="nav-link">
                        <i>âš™ï¸</i> ç³»ç»Ÿè®¾ç½®
                    </a>
                </div>
            </div>
        </nav>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <main class="main-content">
            <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
            <header class="topbar">
                <div class="topbar-left">
                    <a href="{{ url_for('admin.users') }}" class="back-btn">â† è¿”å›ç”¨æˆ·åˆ—è¡¨</a>
                    <h1>ç”¨æˆ·è¯¦æƒ…</h1>
                </div>
                <div class="topbar-right">
                    <div class="user-info">
                        <div class="user-avatar">
                            {{ current_user.student_id[0] if current_user.student_id else 'A' }}
                        </div>
                        <span>{{ current_user.student_id or 'ç®¡ç†å‘˜' }}</span>
                    </div>
                    <a href="{{ url_for('admin.admin_logout') }}" class="logout-btn">é€€å‡ºç™»å½•</a>
                </div>
            </header>

            <!-- å†…å®¹åŒºåŸŸ -->
            <div class="content-area">
                <!-- ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ -->
                <div class="user-profile">
                    <div class="profile-header">
                        <div class="profile-avatar">
                            {{ user.student_id[0] if user.student_id else user.email[0] if user.email else 'U' }}
                        </div>
                        <div class="profile-info">
                            <h2>{{ user.student_id or 'æœªè®¾ç½®å­¦å·' }}</h2>
                            <p>{{ user.email or 'æœªè®¾ç½®é‚®ç®±' }}</p>
                        </div>
                    </div>
                    <div class="profile-body">
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">å­¦å·</span>
                                <span class="info-value">{{ user.student_id or 'æœªè®¾ç½®' }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">é‚®ç®±</span>
                                <span class="info-value">{{ user.email or 'æœªè®¾ç½®' }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">æ³¨å†Œæ—¶é—´</span>
                                <span class="info-value">{{ user.created_at.strftime('%Y-%m-%d %H:%M') if user.created_at else 'æœªçŸ¥' }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">æœ€åç™»å½•</span>
                                <span class="info-value">{{ user.last_login.strftime('%Y-%m-%d %H:%M') if user.last_login else 'ä»æœªç™»å½•' }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">è´¦æˆ·çŠ¶æ€</span>
                                <span class="info-value">
                                    {% if user.is_active %}
                                        <span class="status-badge status-active">æ­£å¸¸</span>
                                    {% else %}
                                        <span class="status-badge status-inactive">å·²ç¦ç”¨</span>
                                    {% endif %}
                                </span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">ç®¡ç†å‘˜æƒé™</span>
                                <span class="info-value">
                                    {% if user.is_admin %}
                                        <span class="status-badge status-admin">ç®¡ç†å‘˜ (çº§åˆ« {{ user.admin_level }})</span>
                                    {% else %}
                                        <span class="status-badge">æ™®é€šç”¨æˆ·</span>
                                    {% endif %}
                                </span>
                            </div>
                        </div>

                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="editUser()">ç¼–è¾‘ç”¨æˆ·</button>
                            {% if user.is_admin %}
                                <button class="btn btn-warning" onclick="toggleAdmin({{ user.id }}, false)">å–æ¶ˆç®¡ç†å‘˜</button>
                            {% else %}
                                <button class="btn btn-warning" onclick="toggleAdmin({{ user.id }}, true)">è®¾ä¸ºç®¡ç†å‘˜</button>
                            {% endif %}
                            <button class="btn btn-danger" onclick="deleteUser({{ user.id }})">åˆ é™¤ç”¨æˆ·</button>
                        </div>
                    </div>
                </div>

                <!-- ç”¨æˆ·ç»Ÿè®¡ -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">{{ user.lost_found_items|length or 0 }}</div>
                        <div class="stat-label">å¤±ç‰©æ‹›é¢†å‘å¸ƒ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ user.secondhand_books|length or 0 }}</div>
                        <div class="stat-label">äºŒæ‰‹ä¹¦å‘å¸ƒ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ user.course_reviews|length or 0 }}</div>
                        <div class="stat-label">è¯¾ç¨‹è¯„ä»·</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ user.study_groups|length or 0 }}</div>
                        <div class="stat-label">å­¦ä¹ å°ç»„</div>
                    </div>
                </div>

                <!-- ç”¨æˆ·æ´»åŠ¨è®°å½• -->
                <div class="activity-section">
                    <div class="section-header">
                        <h3 class="section-title">ğŸ“‹ æœ€è¿‘æ´»åŠ¨</h3>
                    </div>
                    <div class="activity-list">
                        <div class="activity-item">
                            <div class="activity-icon activity-login">ğŸ”‘</div>
                            <div class="activity-content">
                                <div class="activity-title">ç”¨æˆ·ç™»å½•</div>
                                <div class="activity-desc">ä» IP åœ°å€ 192.168.1.100 ç™»å½•ç³»ç»Ÿ</div>
                            </div>
                            <div class="activity-time">2å°æ—¶å‰</div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-icon activity-post">ğŸ“</div>
                            <div class="activity-content">
                                <div class="activity-title">å‘å¸ƒå¤±ç‰©æ‹›é¢†</div>
                                <div class="activity-desc">å‘å¸ƒäº†ä¸€æ¡å…³äº"ä¸¢å¤±é’±åŒ…"çš„å¤±ç‰©æ‹›é¢†ä¿¡æ¯</div>
                            </div>
                            <div class="activity-time">1å¤©å‰</div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-icon activity-comment">ğŸ’¬</div>
                            <div class="activity-content">
                                <div class="activity-title">è¯„ä»·è¯¾ç¨‹</div>
                                <div class="activity-desc">å¯¹"é«˜ç­‰æ•°å­¦"è¯¾ç¨‹è¿›è¡Œäº†è¯„ä»·</div>
                            </div>
                            <div class="activity-time">3å¤©å‰</div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-icon activity-post">ğŸ“š</div>
                            <div class="activity-content">
                                <div class="activity-title">å‘å¸ƒäºŒæ‰‹ä¹¦</div>
                                <div class="activity-desc">å‘å¸ƒäº†"Javaç¼–ç¨‹æ€æƒ³"äºŒæ‰‹ä¹¦ä¿¡æ¯</div>
                            </div>
                            <div class="activity-time">1å‘¨å‰</div>
                        </div>
                    </div>
                </div>

                <!-- ç¼–è¾‘ç”¨æˆ·è¡¨å•ï¼ˆé»˜è®¤éšè—ï¼‰ -->
                <div class="edit-form" id="editForm" style="display: none;">
                    <h3 style="margin-bottom: 20px; color: #2c3e50;">âœï¸ ç¼–è¾‘ç”¨æˆ·ä¿¡æ¯</h3>
                    <form method="POST" action="{{ url_for('admin.user_detail', user_id=user.id) }}">
                        <div class="form-group">
                            <label class="form-label">å­¦å·</label>
                            <input type="text" class="form-input" name="student_id" value="{{ user.student_id or '' }}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">é‚®ç®±</label>
                            <input type="email" class="form-input" name="email" value="{{ user.email or '' }}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">è´¦æˆ·çŠ¶æ€</label>
                            <select class="form-select" name="is_active">
                                <option value="1" {{ 'selected' if user.is_active else '' }}>æ­£å¸¸</option>
                                <option value="0" {{ 'selected' if not user.is_active else '' }}>å·²ç¦ç”¨</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ç®¡ç†å‘˜çº§åˆ«</label>
                            <select class="form-select" name="admin_level">
                                <option value="0" {{ 'selected' if user.admin_level == 0 else '' }}>æ™®é€šç”¨æˆ·</option>
                                <option value="1" {{ 'selected' if user.admin_level == 1 else '' }}>åˆçº§ç®¡ç†å‘˜</option>
                                <option value="2" {{ 'selected' if user.admin_level == 2 else '' }}>é«˜çº§ç®¡ç†å‘˜</option>
                            </select>
                        </div>
                        <div class="action-buttons">
                            <button type="submit" class="btn btn-primary">ä¿å­˜ä¿®æ”¹</button>
                            <button type="button" class="btn btn-warning" onclick="cancelEdit()">å–æ¶ˆ</button>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <script>
        function editUser() {
            document.getElementById('editForm').style.display = 'block';
            document.querySelector('.user-profile').style.display = 'none';
        }

        function cancelEdit() {
            document.getElementById('editForm').style.display = 'none';
            document.querySelector('.user-profile').style.display = 'block';
        }

        function toggleAdmin(userId, makeAdmin) {
            const action = makeAdmin ? 'è®¾ä¸ºç®¡ç†å‘˜' : 'å–æ¶ˆç®¡ç†å‘˜æƒé™';
            if (confirm(`ç¡®å®šè¦${action}å—ï¼Ÿ`)) {
                // è¿™é‡Œå¯ä»¥æ·»åŠ  AJAX è¯·æ±‚
                fetch(`/admin/users/${userId}/toggle_admin`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ make_admin: makeAdmin })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('æ“ä½œå¤±è´¥ï¼š' + data.message);
                    }
                })
                .catch(error => {
                    alert('æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                });
            }
        }

        function deleteUser(userId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç”¨æˆ·å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                // è¿™é‡Œå¯ä»¥æ·»åŠ  AJAX è¯·æ±‚
                fetch(`/admin/users/${userId}/delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('ç”¨æˆ·å·²åˆ é™¤');
                        window.location.href = '/admin/users';
                    } else {
                        alert('åˆ é™¤å¤±è´¥ï¼š' + data.message);
                    }
                })
                .catch(error => {
                    alert('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                });
            }
        }
    </script>
</body>
</html>