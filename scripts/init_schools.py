#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""初始化学校数据（SQLAlchemy）"""

import os
import sys
sys.path.insert(0, os.path.dirname(os.path.dirname(__file__)))

from app import create_app
from app.models import db, School

SAMPLE_SCHOOLS = [
    {"name": "鲲擎大学", "code": "KQU", "province": "江苏省", "city": "昆擎市"},
    {"name": "北京大学", "code": "PKU", "province": "北京市", "city": "北京"},
    {"name": "清华大学", "code": "THU", "province": "北京市", "city": "北京"},
    {"name": "复旦大学", "code": "FDU", "province": "上海市", "city": "上海"},
    {"name": "上海交通大学", "code": "SJTU", "province": "上海市", "city": "上海"},
    {"name": "浙江大学", "code": "ZJU", "province": "浙江省", "city": "杭州"},
    {"name": "南京大学", "code": "NJU", "province": "江苏省", "city": "南京"},
    {"name": "武汉大学", "code": "WHU", "province": "湖北省", "city": "武汉"},
    {"name": "华中科技大学", "code": "HUST", "province": "湖北省", "city": "武汉"},
]

# 扩展省份学校名单（来源于用户提供，按省份分类并整体去重）
EXTENDED_SCHOOLS = {
    "安徽": [
        "安徽农业大学", "安徽中医药大学", "皖南医学院", "合肥大学", "安庆师范大学",
        "安徽医科大学", "安徽工业大学", "蚌埠医科大学",
    ],
    "福建": [
        "福建师范大学", "福建医科大学", "福建中医药大学", "福建农林大学", "福建理工大学",
        "厦门理工学院", "集美大学",
    ],
    "广东": [
        "广东金融学院", "东莞理工学院", "广东技术师范大学", "广东警官学院", "广东第二师范学院",
        "广东海洋大学", "广东药科大学", "五邑大学", "佛山科学技术学院",
    ],
    "河北": [
        "河北医科大学", "河北中医药大学", "河北工程大学", "河北农业大学", "河北地质大学",
        "河北金融学院", "承德医学院", "北华航天工业学院",
    ],
    "河南": [
        "河南师范大学", "河南农业大学", "河南科技大学", "河南理工大学", "河南中医药大学",
        "郑州轻工业大学", "信阳师范大学", "中原工学院",
    ],
    "湖北": [
        "湖北大学", "武汉轻工大学", "湖北中医药大学", "湖北经济学院", "湖北师范大学",
        "湖北医药学院", "湖北第二师范学院",
    ],
    "江苏": [
        "南京工程学院", "南京晓庄学院", "江苏警官学院", "金陵科技学院", "江苏第二师范学院",
        "江苏理工学院", "常州大学", "南通大学",
    ],
    "山东": [
        "山东科技大学", "山东农业大学", "山东财经大学", "山东第一医科大学", "山东中医药大学",
        "山东理工大学", "山东第二医科大学", "青岛科技大学", "济南大学",
    ],
    "浙江": [
        "温州医科大学", "浙江中医药大学", "温州大学", "浙江财经大学", "浙江科技大学",
        "浙江海洋大学", "浙江外国语学院", "杭州医学院", "嘉兴大学",
    ],
    # 其他省份
    "四川": ["成都医学院", "川北医学院"],
    "吉林": ["吉林农业大学", "长春中医药大学", "东北电力大学"],
    "陕西": ["西安邮电大学"],
    "辽宁": ["辽宁师范大学"],
    "山西": ["山西大学"],
    "云南": ["昆明理工大学"],
    "广西": ["广西医科大学"],
    "甘肃": ["西北师范大学"],
    "江西": ["华东交通大学"],
    "湖南": ["湖南中医药大学"],
    "黑龙江": ["哈尔滨医科大学"],
    # 云南省详单（本科+专科合并，整体去重）
    "云南": [
        # 公办本科（26所）
        "云南大学", "昆明理工大学", "云南农业大学", "西南林业大学", "昆明医科大学",
        "大理大学", "云南中医药大学", "云南师范大学", "昭通学院", "曲靖师范学院",
        "普洱学院", "保山学院", "红河学院", "云南财经大学", "云南艺术学院",
        "云南民族大学", "玉溪师范学院", "楚雄师范学院", "云南警官学院", "昆明学院",
        "文山学院", "滇西科技师范学院", "滇西应用技术大学", "曲靖健康医学院",
        "丽江师范学院", "德宏师范学院",
        # 民办本科（9所）
        "云南经济管理学院", "滇池学院", "丽江文化旅游学院", "昆明理工大学津桥学院",
        "昆明城市学院", "昆明文理学院", "昆明医科大学海源学院", "昆明传媒学院",
        "云南工商学院",
        # 公办专科（46所）
        "昆明冶金高等专科学校", "云南国土资源职业学院", "云南交通职业技术学院",
        "昆明工业职业技术学院", "云南农业职业技术学院", "云南司法警官职业学院",
        "云南文化艺术职业学院", "云南体育运动职业技术学院", "西双版纳职业技术学院",
        "玉溪农业职业技术学院", "云南能源职业技术学院", "云南国防工业职业技术学院",
        "云南机电职业技术学院", "云南林业职业技术学院", "楚雄医药高等专科学校",
        "保山中医药高等专科学校", "云南锡业职业技术学院", "德宏职业学院",
        "云南现代职业技术学院", "云南旅游职业学院", "红河卫生职业学院",
        "大理农林职业技术学院", "公安消防部队高等专科学校", "云南财经职业学院",
        "昆明铁道职业技术学院", "昭通卫生职业学院", "大理护理职业学院",
        "云南水利水电职业学院", "云南轻纺职业学院", "云南特殊教育职业学院",
        "云南工贸职业技术学院", "云南交通运输职业学院", "昆明幼儿师范高等专科学校",
        "曲靖职业技术学院", "红河职业技术学院", "玉溪职业技术学院", "保山职业学院",
        "昭通职业学院", "文山职业技术学院", "丽江职业技术学院", "香格里拉职业学院",
        "怒江职业技术学院", "临沧职业学院", "云南工业信息职业学院",
        # 民办专科（11所，整合去重）
        "云南科技信息职业学院", "昆明艺术职业学院", "云南城市建设职业学院",
        "云南工程职业学院", "云南新兴职业学院", "云南经贸外事职业学院",
        "云南三鑫职业技术学院", "云南商务职业学院", "昆明卫生职业学院",
        "云南外事外语职业学院", "云南医药健康职业学院", "云南理工职业学院",
    ],
}

def _normalize_name(name: str) -> str:
    """标准化学校名称"""
    return (name or "").replace("\u3000", " ").replace("、", "").strip()

def build_extended_records():
    """将扩展名单转换为记录列表，并按学校名称去重。"""
    seen = set()
    records = []
    for province, names in EXTENDED_SCHOOLS.items():
        for raw in names:
            n = _normalize_name(raw)
            if not n:
                continue
            if n in seen:
                continue
            seen.add(n)
            records.append({"name": n, "code": None, "province": province, "city": None})
    return records


def main():
    app = create_app()
    with app.app_context():
        # 创建表
        db.create_all()

        # 构建最终插入清单（内置样例 + 扩展名单，按名称去重）
        insert_candidates = list(SAMPLE_SCHOOLS) + build_extended_records()

        # 查询现有名称，避免重复插入（增量执行安全）
        existing_names = {n for (n,) in db.session.query(School.name).all()}
        to_insert = [s for s in insert_candidates if s["name"] not in existing_names]

        if not to_insert:
            print(f"[InitSchools] 无需插入，所有样例/扩展学校已存在（现有 {len(existing_names)} 条）")
            return

        for s in to_insert:
            school = School(
                name=s["name"], 
                code=s.get("code"), 
                province=s.get("province"), 
                city=s.get("city"),
            )
            db.session.add(school)
        db.session.commit()
        print(f"[InitSchools] 插入完成，本次新增 {len(to_insert)} 条；当前总数 {School.query.count()} 条")


if __name__ == "__main__":
    main()