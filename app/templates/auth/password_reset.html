{% extends 'base.html' %}
{% block title %}重置密码 - Kunqing Campus{% endblock %}
{% block content %}
<div class="row justify-content-center">
  <div class="col-12 col-md-6">
    <div class="card glass-card">
      <div class="card-header">重置密码</div>
      <div class="card-body">
        <form method="post" id="resetForm">
          {{ form.hidden_tag() }}
          <div class="mb-3">
            {{ form.email.label(class="form-label") }}
            <div class="input-group">
              {{ form.email(class="form-control", placeholder="注册邮箱") }}
              <button type="button" class="btn btn-outline-secondary" id="sendCodeBtn">发送验证码</button>
            </div>
            {% for err in form.email.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
            <div id="sendCodeTip" class="form-text"></div>
          </div>
          <div class="mb-3">
            {{ form.captcha.label(class="form-label") }}
            {{ form.captcha(class="form-control", placeholder="邮箱验证码") }}
            {% for err in form.captcha.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
          </div>
          <div class="mb-3">
            {{ form.new_password.label(class="form-label") }}
            {{ form.new_password(class="form-control", placeholder="新密码（至少8位）") }}
            {% for err in form.new_password.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
          </div>
          <div class="mb-3">
            {{ form.confirm_password.label(class="form-label") }}
            {{ form.confirm_password(class="form-control", placeholder="重复新密码") }}
            {% for err in form.confirm_password.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
          </div>
          {{ form.submit(class="btn btn-primary w-100") }}
        </form>
        <div class="mt-3 text-center">
          <a href="{{ url_for('auth.login') }}">返回登录</a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.getElementById('sendCodeBtn').addEventListener('click', async function() {
  const emailInput = document.querySelector('#resetForm input[name="email"]');
  const tip = document.getElementById('sendCodeTip');
  const email = emailInput ? emailInput.value.trim() : '';
  tip.textContent = '';
  if (!email) {
    tip.textContent = '请先填写邮箱';
    tip.className = 'form-text text-danger';
    return;
  }
  try {
    const fd = new FormData();
    fd.append('email', email);
    const resp = await fetch('{{ url_for('auth.send_reset_captcha') }}', { method: 'POST', body: fd });
    const data = await resp.json();
    if (data.sent) {
      tip.textContent = '验证码已发送，请检查邮箱';
      tip.className = 'form-text text-success';
      // 启动倒计时并禁用按钮 60 秒
      const btn = document.getElementById('sendCodeBtn');
      btn.disabled = true;
      let remain = 60;
      const origText = btn.textContent;
      btn.textContent = `重新发送(${remain}s)`;
      const timer = setInterval(() => {
        remain -= 1;
        btn.textContent = `重新发送(${remain}s)`;
        if (remain <= 0) {
          clearInterval(timer);
          btn.disabled = false;
          btn.textContent = origText;
        }
      }, 1000);
    } else {
      tip.textContent = data.error || '发送失败，请稍后重试';
      tip.className = 'form-text text-danger';
    }
  } catch (err) {
    tip.textContent = '网络错误，请稍后重试';
    tip.className = 'form-text text-danger';
  }
});
</script>
{% endblock %}